---
title: "3.1 - Model data analysis & initial linear model"
output: 
  github_document:
    df_print: kable
---
```{r echo=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE,message=FALSE,dpi=300,comment=NA, warning=FALSE, fig.path="Figs/")
```

```{r}
library(tidyverse)
library(ridge)
library(broom)
library(gridExtra)
library(reshape)
load('../3.0 - Model Data/LR.NO2.rda')
load('../3.0 - Model Data/LR.NO2.direction.rda')
```

In this section the data set **LR.NO2.rda** is analysed and an initial linear model of NO2 against all the traffic, weather, and average journey speed variables is fitted.

#3.1.1 Model data analysis:

### Traffic counts and NO2 pollution levels:

Figure 3.1(a) shows counts of cars, vans, buses and trucks per 15 minute interval against NO2 levels, where the direction of travel has been combined.

```{r}
LR.NO2 %>% mutate(
  #Adding Columns for types of vehicle:
  car = pcar_E3 + pcar_E4 + pcar_E5 + pcar_E6 + dcar_E3 + dcar_E4  + dcar_E5 + dcar_E6,
  truck = ptruck_E3 + dtruck_E3 + dtruck_E4 + dtruck_E5 + dtruck_E6,
  van = pvan_E3 + pvan_E4 + pvan_E5 + pvan_E6 + dvan_E3 + dvan_E4 + dvan_E5 + dvan_E6,
  bus = dbus_E3 + dbus_E4 + dbus_E5 + dbus_E6 ) -> LR.NO2.types

LR.NO2.types %>% ggplot(aes(x=car,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='red') + xlab("Number of cars per 15 minute interval") + ylab("NO2 (ppb)") -> car
LR.NO2.types %>% ggplot(aes(x=van,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm') + xlab("Number of vans per 15 minute interval") + ylab("NO2 (ppb)")-> van
LR.NO2.types %>% ggplot(aes(x=bus,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='purple') + xlab("Number of buses per 15 minute interval")+ ylab("NO2 (ppb)")-> bus
LR.NO2.types %>% ggplot(aes(x=truck,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='green') + xlab("Number of trucks per 15 minute interval")+ ylab("NO2 (ppb)") -> truck
grid.arrange(car,van,bus,truck,top="Figure 3.1 (a): NO2 vs vehicle type:")
```

There is evidence of a positive linear relationship between traffic counts and NO2 pollution levels. This suggests that as vehicle counts increase, NO2 levels increase.

### Weather variables and NO2 pollution levels:

Figure 3.1(b) shows plots of air pressure, humidity, wind speed, wind direction and temperature against NO2 levels.

```{r}
LR.NO2.types %>% ggplot(aes(x=pressure,y=NO2)) + geom_point(size=0.4,alpha=0.5) + geom_smooth(method='lm') + ylab("NO2 (ppb)") + xlab("Air pressure (hPa)") -> p
LR.NO2.types %>% ggplot(aes(x=humidity,y=NO2)) + geom_point(size=0.4,alpha=0.5) + geom_smooth(method='lm') + ylab("NO2 (ppb)") + xlab("Humidity (%)") -> h
LR.NO2.types %>% ggplot(aes(x=windSpeed,y=NO2)) + geom_point(size=0.4,alpha=0.5) + geom_smooth(method='lm') + ylab("NO2 (ppb)") + xlab("Wind speed (kmph)") -> ws
LR.NO2.types %>% ggplot(aes(x=windDirectionDegrees,y=NO2)) + geom_point(size=0.5,alpha=0.5) + ylab("NO2 (ppb)") + xlab("Wind direction degrees") -> wdd
LR.NO2.types %>% ggplot(aes(x=temperature,y=NO2)) + geom_point(size=0.4,alpha=0.5) + geom_smooth(method='lm')  + ylab("NO2 (ppb)") + xlab(expression("Temperature ("*~degree*C*")")) -> t
LR.NO2.types %>% ggplot(aes(x=hourlyPrecip,y=NO2)) + geom_point(size=0.4,alpha=0.5) + geom_smooth(method='lm')  + ylab("NO2 (ppb)") + xlab(expression("Precipitation (mm)")) -> precip

grid.arrange(p,h,ws,wdd,t,precip,top="Figure 3.1 (b): NO2 vs weather variables:")

```

There is evidence of the following relationships:

- Positive linear relationships between NO2 pollution levels and air pressure, and temperature.
- Negative linear relationships between NO2 pollution levels and humidity, wind speed, and precipitation.
- Clusterings of points on the wind direction degrees plot, may suggest that the wind direction has a radial effect on NO2 pollution.

There is however a relationship between temperature and vehicle counts, as shown in figure 3.1 (c).

```{r}
LR.NO2.types %>% ggplot(aes(x=car,y=temperature)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='red') + xlab("Number of cars per 15 minute interval") + ylab(expression("Temperature ("*~degree*C*")"))  -> car
LR.NO2.types %>% ggplot(aes(x=van,y=temperature)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm') + xlab("Number of vans per 15 minute interval") + ylab(expression("Temperature ("*~degree*C*")")) -> van
LR.NO2.types %>% ggplot(aes(x=bus,y=temperature)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='purple') + xlab("Number of buses per 15 minute interval") + ylab(expression("Temperature ("*~degree*C*")")) -> bus
LR.NO2.types %>% ggplot(aes(x=truck,y=temperature)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='green') + xlab("Number of trucks per 15 minute interval") + ylab(expression("Temperature ("*~degree*C*")")) -> truck
grid.arrange(car,van,bus,truck,top="Figure 3.1 (c): Temperature vs vehicle type:")
```

This is not unexpected, since (as found in section 1.1) traffic counts increase during the day time and then decrease during the night time, as does the temperature (found in section 0.4). This could be problematic when modelling the effect of vehicles on NO2 levels. Hence the author has decided to remove this variable from all future modelling in this study.

### Average journey speed and NO2 pollution levels:

Figures 3.1 (d) & (c), show plots of mean average journey speeds between London Road and Swainswick/Box Road/Warminster Road/Bear Flat, per 15 minute interval, against NO2 levels.

```{r}
LR.NO2.types %>% ggplot(aes(x=from_14_to_2,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm,col='red') + ylab("NO2 (ppb)") + xlab("Average speed per 15 minute interval (mph)") + ggtitle("London Road to Swainswick") -> a
LR.NO2.types %>% ggplot(aes(x=from_2_to_14,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm,col='red') + ylab("NO2 (ppb)") + xlab("Average speed per 15 minute interval (mph)") + ggtitle("Swainswick to London Road") -> b
LR.NO2.types %>% ggplot(aes(x=from_14_to_3,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm) + ylab("NO2 (ppb)") + xlab("Average speed per 15 minute interval (mph)") + ggtitle("London Road to Box Road")-> c
LR.NO2.types %>% ggplot(aes(x=from_3_to_14,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm) + xlab("Average speed per 15 minute interval (mph)") + ggtitle("Box Road to London Road") -> d
grid.arrange(a,b,c,d,top="Figure 3.1 (d): NO2 vs average journey speed:")

LR.NO2.types %>% ggplot(aes(x=from_14_to_15,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm,col='purple') + ylab("NO2 (ppb)") + xlab("Average speed per 15 minute interval (mph)") + ggtitle("London Road to Warminster Road") -> e
LR.NO2.types %>% ggplot(aes(x=from_15_to_14,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm,col='purple') + ylab("NO2 (ppb)") + xlab("Average speed per 15 minute interval (mph)") + ggtitle("Warminster Road to London Road")-> f
LR.NO2.types %>% ggplot(aes(x=from_14_to_20,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm,col='green') + ylab("NO2 (ppb)") + xlab("Average speed per 15 minute interval (mph)") + ggtitle("London Road to Bear Flat") -> g
LR.NO2.types %>% ggplot(aes(x=from_20_to_14,y=NO2)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method=lm,col='green') + ylab("NO2 (ppb)") + xlab("Average speed per 15 minute interval (mph)") + ggtitle("Bear Flat to London Road") -> h
grid.arrange(e,f,g,h,top="Figure 3.1 (e): NO2 vs average journey speed:")
```

From these graphs, there is evidence to suggest that faster average journey speeds result in lower levels of NO2 pollution. There is a strange observation shown on the London Road to Swainswick graph, where the average journey speed per 15 minute interval is extremely fast. This observation will be discussed in the next subsection.

### Traffic counts and average journey speed:

Figure 3.1 (f), shows plots of mean average journey speeds from Swainswick to London Road against counts of vehicles travelling in the same direction through London Road  per 15 minute interval (westerly travelling vehicles), for cars, vans, buses, and trucks.

```{r}
LR.NO2.direction %>% mutate(
  carw = pcarw_E3 + pcarw_E4 + pcarw_E5 + pcarw_E6 + dcarw_E3 + dcarw_E4 + dcarw_E5 + dcarw_E6,
  care = pcare_E3 + pcare_E4 + pcare_E5 + pcare_E6 + dcare_E3 + dcare_E4 + dcare_E5 + dcare_E6,
  vanw = pvanw_E3 + pvanw_E4 + pvanw_E5 + pvanw_E6 + dvanw_E3 + dvanw_E4 + dvanw_E5 + dvanw_E6,
  vane = pvane_E3 + pvane_E4 + pvane_E5 + pvane_E6 + dvane_E3 + dvane_E4 + dvane_E5 + dvane_E6,
  trucke = ptrucke_E3 + dtrucke_E3 + dtrucke_E4 + dtrucke_E5 + dtrucke_E6,
  truckw = ptruckw_E3 + dtruckw_E3 + dtruckw_E4 + dtruckw_E5 + dtruckw_E6,
  buse = dbuse_E3 + dbuse_E4 + dbuse_E5 + dbuse_E6,
  busw = dbusw_E3 + dbusw_E4 + dbusw_E5 + dbusw_E6) -> LR.NO2.direction

LR.NO2.direction %>% filter(carw>0|vanw>0|truckw>0|busw>0) -> LR.NO2.direction.w

LR.NO2.direction.w %>% ggplot(aes(x=carw,y=from_2_to_14)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='red') + xlab("Westerly cars per 15 minute interval") + ylab("Average speed (mph)") -> car
LR.NO2.direction.w %>% ggplot(aes(x=vanw,y=from_2_to_14)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm') + xlab("Westerly vans per 15 minute interval") + ylab("Average speed (mph)")-> van
LR.NO2.direction.w %>% ggplot(aes(x=busw,y=from_2_to_14)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='purple') + xlab("Westerly buses per 15 minute interval")+ ylab("Average speed (mph)")-> bus
LR.NO2.direction.w %>% ggplot(aes(x=truckw,y=from_2_to_14)) + geom_point(size=0.5,alpha=0.5) + geom_smooth(method='lm',col='green') + xlab("Westerly trucks per 15 minute interval")+ ylab("Average speed (mph)") -> truck
grid.arrange(car,van,bus,truck,top="Figure 3.1 (f): Average journey speed from Swainswick to London Road vs vehicle type:")
```

There is evidence to suggest that as vehicle counts increase, average journey speeds decrease. Similar observations can be made for other ANPR sites.


#3.1.2 Initial linear model:

In this subsection, a linear model of NO2 against all the traffic, weather and average journey speed predictor variables, is fitted. The sine and cosine functions for the variable **windDirection** have been chosen to capture the radial affect of the wind direction on NO2 pollution levels. A better fitting model can be achieved through taking a log-transformation of the response variable **NO2**. However, it would be unnatural for traffic counts to have a multiplicative effect on NO2 levels. The author has decided to leave the response variable **NO2** untransformed in all the models in this study. 

Fitting an initial linear model:

```{r}
#Model formula:
formula <- NO2 ~ pcar_E3 + pcar_E4 + pcar_E5 + pcar_E6 + dcar_E3 + dcar_E4 + dcar_E5 + dcar_E6 + pvan_E3 + pvan_E4 + pvan_E5 + pvan_E6 + dvan_E3 + dvan_E4 + dvan_E5 +  dvan_E6 + dbus_E3 + dbus_E4 + dbus_E5 + dbus_E6 + ptruck_E3 + dtruck_E3 + dtruck_E4 + dtruck_E5 + dtruck_E6 + hourlyPrecip + humidity + windSpeed + pressure + cos(2*pi*windDirectionDegrees/360) + sin(2*pi*windDirectionDegrees/360) + from_14_to_15 + from_15_to_14 + from_2_to_14 + from_3_to_14 + from_14_to_2 + from_14_to_3 + from_20_to_14 + from_14_to_20

#Fit the model:
lm <- lm(formula,LR.NO2)

#Return r.squared, adj.r.squared, sigma, p.value, AIC:
glance(lm) %>% select(r.squared, adj.r.squared, sigma, p.value, AIC) %>% data.frame()

#Diagnostic Plots:

par(mfrow=c(2,2))
plot(lm,pch=20,cex = .2)
```

Row 1344 has a high leverage on the model. Examining row 1344 of of **LR.NO2** further:

```{r}
LR.NO2[1344,] %>% select(DateTime,from_2_to_14,from_3_to_14,from_14_to_2,from_14_to_3,from_15_to_14,from_20_to_14,from_14_to_15,from_14_to_20) %>% data.frame()
```

The mean average journey speed for the 15 minute interval starting at 23:45 on 13th November for vehicles travelling from London Road to Swainswick (from_14_to_2), is 184 mph. Someone must have been in a rush. This observation can be seen in figure 3.1 (d). Excluding this row and refitting the model:

```{r}
#Refitting the model:
lm <- lm(formula,LR.NO2[-1344,])

#Return Estimates:
tidy(lm) %>% select(term,estimate,std.error,p.value) %>% mutate(estimate=round(estimate,5),std.error=round(std.error,5),p.value=round(p.value,5))

#Return r.squared, adj.r.squared, sigma, p.value, AIC:
glance(lm) %>% select(r.squared, adj.r.squared, sigma, p.value, AIC)

#Diagnostic Plots:

par(mfrow=c(2,2))
plot(lm,pch=20,cex = .2)
```

Hourly precipitation is insignificant and will be omitted from all future models in this study. All of the other weather predictors are significant. There is evidence to suggest that:

- As humidity/wind speed increase, NO2 pollution levels decrease.
- As pressure increases, NO2 pollution levels increase.
- The wind direction has an effect on NO2 pollution levels.

Most of the average vehicle journey speed variables are significant. Of those that are significant, there is evidence to suggest that a faster average vehicle journey speed results in lower NO2 pollution levels.

Many of the vehicle variables are statistically insignificant. Additionally we have negative estimates for some of the vehicle variables. This is counter intuitive. However, some of the vehicle variables are highly correlated, for example looking at the correlation between the different car categories:

```{r}
LR.NO2 %>% select(pcar_E3,pcar_E4,pcar_E5,pcar_E6,dcar_E3,dcar_E4,dcar_E5,dcar_E6) %>% cor() %>% round(2)
```


The author has attempted using ridge regression on this model to force all the coefficients greater than zero and to become significant. For example, setting the ridge regression parameter lambda to 500:

```{r}
#Fitting linear ridge regression model:
lr <- linearRidge(formula,LR.NO2[-1344,],lambda=500)
#This function returns estimates and p-values from the linear ridge model:
look <- function(ridge.model){summary(ridge.model)$summaries$summary1$coefficients[,c(1,5)] %>% round(5) %>% data.frame() ->df; names(df)<-c("estimate","p.value"); df}
#Return estimates:
look(lr)
```

Looking at a graphical comparison between this model and the linear model:

```{r}
#Comparison of models
dat <- LR.NO2[-1344,]
data.frame(DateTime=dat$DateTime,lm=predict(lm),lr=predict(lr)) %>% melt(id.vars="DateTime") %>% ggplot() + geom_line(mapping=aes(y=value,x=as.POSIXct(DateTime),color=variable)) + scale_x_datetime(date_breaks = "1 day",date_labels ='%a\n%b\n%d') + xlab("Date/Time")+ylab("NO2 (ppb)") + ggtitle("Comparison of fitted values for linear model and linear ridge model:") + geom_point(LR.NO2,mapping=aes(y=NO2,x=DateTime),size=0.2,alpha=0.5)
```

Smoothing has lead to an extremely poor fit and not all the traffic predictors are significant. Ridge regression has been unsuccessful with this model. In section 3.2, variables will be linearly combined together, to assess the effect of vehicle type, fuel type, Euro emission standards, and average journey speeds on NO2 pollution levels. Section 3.3 will consider a constrained version of a model given in section 3.2.1. And section 3.4, will investigate the effect of traffic counts on average journey speeds.

